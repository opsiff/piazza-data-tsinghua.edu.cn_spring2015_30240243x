$(document).ready(function(){var url=parent.window.location.search;var args={};if(url.indexOf('?')!=-1){var str=url.substr(1);var arglist=str.split('&');for(var i in arglist){argstr=arglist[i];if(argstr!=null&argstr!=''){var key=argstr.split('=')[0];var value=argstr.split('=')[1];if(args[key]==undefined){args[key]=[]}args[key].push(decodeURI(value))}}var tags=args["tags"];var tags_arg=tags[0].split(",");if(tags_arg.length>0){quickSelect(tags_arg)}}else{init()}});function init(){Handlebars.registerHelper("compare",function(v1,v2,options){if(v1==v2){return options.fn(this)}else{return options.inverse(this)}});url_github="https://cdn.jsdelivr.net/gh/xyongcn/piazza-data-tsinghua.edu.cn_spring2015_30240243x@master/data/piazza-data-filter/piazza_my_feed.json";$.ajax({type:"get",cache:false,url:url_github,success:function(data){var data_json=eval("("+data+")");var source_feed=$("#feed-template").html();var template_feed=Handlebars.compile(source_feed);var html_feed=template_feed(data_json);$("#feed").html(html_feed)}});var source=$("#page-center-template").html();var template=Handlebars.compile(source);url_github="https://cdn.jsdelivr.net/gh/xyongcn/piazza-data-tsinghua.edu.cn_spring2015_30240243x@master/data/piazza-data/1.json";$.ajax({type:"get",cache:false,url:url_github,success:function(data){var data_json=eval("("+data+")");var html=template(data_json);$("#page_center").html(html)}});url_github="https://cdn.jsdelivr.net/gh/xyongcn/piazza-data-tsinghua.edu.cn_spring2015_30240243x@master/data/piazza-data-filter/piazza_my_feed.json";$.ajax({type:"get",cache:false,url:url_github,success:function(data){var data_json=eval("("+data+")");var source_popular=$("#popular-tags-bar-template").html();var template_popular=Handlebars.compile(source_popular);var html_popular=template_popular(data_json);$("#popular_tags_bar").html(html_popular);var source_select=$("#select-linkage-template").html();var template_select=Handlebars.compile(source_select);var html_select=template_select(data_json);$("#top_bar").html(html_select)}})}function quickSelect(tags_arg){var label=tags_arg[0];url_github="https://cdn.jsdelivr.net/gh/xyongcn/piazza-data-tsinghua.edu.cn_spring2015_30240243x@master/data/piazza-data-filter/piazza_my_feed.json";$.ajax({type:"get",cache:false,url:url_github,success:function(data){var data_json=eval("("+data+")");var source_popular=$("#popular-tags-bar-template").html();var template_popular=Handlebars.compile(source_popular);var html_popular=template_popular(data_json);$("#popular_tags_bar").html(html_popular);var source_select=$("#select-linkage-template").html();var template_select=Handlebars.compile(source_select);var html_select=template_select(data_json);$("#top_bar").html(html_select);var allTags=data_json.result.tags.instructor;if(jQuery.inArray(tags_arg[0],allTags)==-1){alert("您所输入的第一个标签不存在，请重新输入！\n为您展示初始选择页面。");init()}else{$("#select_label_1 option").each(function(){if($(this).text()===tags_arg[0]){$(this).attr('selected','selected')}});var obj=document.getElementById("select_label_1");gen_multi_selector(obj,tags_arg)}}})}function gen_multi_selector(obj,tags_arg){var opt=obj.options[obj.selectedIndex]var label=opt.text;url_github="https://cdn.jsdelivr.net/gh/xyongcn/piazza-data-tsinghua.edu.cn_spring2015_30240243x@master/data/piazza-data-filter/filter_feed_"+label+".json";$.ajax({type:"get",cache:false,url:url_github,success:function(data){var data_json=eval("("+data+")");var source_feed=$("#feed-template").html();var template_feed=Handlebars.compile(source_feed);var html_feed=template_feed(data_json);$("#feed").html(html_feed);var next_data=gen_next_list(label,data_json);next_data=eval("("+next_data+")");var c_tags=[];for(var i=0;i<next_data.children.length;i++){c_tags.push(next_data.children[i].tag)}var init_cid=next_data.children[0].ids[0];clickLi(init_cid);addNextSbiling(label,obj.id,label,next_data);var source_select=$("#select-linkage-template").html();var template_select=Handlebars.compile(source_select);var html_select=template_select(next_data);var ID="#"+label;$(ID).html(html_select);for(var i=1;i<tags_arg.length;i++){if(jQuery.inArray(tags_arg[i],c_tags)==-1){alert("您输入的第"+String(i+1)+"个标签不在可选范围内！\n为您显示前"+String(i)+"个标签的筛选结果。");clickLi(init_cid);break}else{var c_id="#"+tags_arg[i-1];var Id=tags_arg[i-1];var c_label=tags_arg[i];var value;$(c_id+" option").each(function(){if($(this).text()===c_label){value=$(this).val()}});$(c_id+" option").each(function(){if($(this).text()===c_label){$(this).attr('selected','selected')}});upd_feed(value,tags_arg[0]);var IdArray=value.split(",");var next_data_new=gen_next_taglist(IdArray,$(c_id).find("option:selected").text(),next_data);addNextSbiling(tags_arg[0],Id,$(c_id).find("option:selected").text(),next_data_new);var source_select=$("#select-linkage-template").html();var template_select=Handlebars.compile(source_select);var html_select=template_select(next_data_new);var ID="#"+$(c_id).find("option:selected").text();$(ID).html(html_select)}}if(IdArray[0]){clickLi(IdArray[0])}}})}function clickLi(cid){var source=$("#page-center-template").html();var template=Handlebars.compile(source);Handlebars.registerHelper("compare",function(v1,v2,options){if(v1==v2){return options.fn(this)}else{return options.inverse(this)}});url_github="https://cdn.jsdelivr.net/gh/xyongcn/piazza-data-tsinghua.edu.cn_spring2015_30240243x@master/data/piazza-data/"+cid+".json";$.ajax({type:"get",cache:false,url:url_github,success:function(data){var data_json=eval("("+data+")");var html=template(data_json);$("#page_center").html(html);$('#toPiazza').attr("href","https://piazza.com/class/i5j09fnsl7k5x0?cid="+cid)}})}function click_tags(label){url_github="https://cdn.jsdelivr.net/gh/xyongcn/piazza-data-tsinghua.edu.cn_spring2015_30240243x@master/data/piazza-data-filter/filter_feed_"+label+".json";$.ajax({type:"get",cache:false,url:url_github,success:function(data){var data_json=eval("("+data+")");var source_feed=$("#feed-template").html();var template_feed=Handlebars.compile(source_feed);var html_feed=template_feed(data_json);$("#feed").html(html_feed)}})}function click_select_label(obj){var opt=obj.options[obj.selectedIndex]var label=opt.text;url_github="https://cdn.jsdelivr.net/gh/xyongcn/piazza-data-tsinghua.edu.cn_spring2015_30240243x@master/data/piazza-data-filter/filter_feed_"+label+".json";$.ajax({type:"get",cache:false,url:url_github,success:function(data){var data_json=eval("("+data+")");var source_feed=$("#feed-template").html();var template_feed=Handlebars.compile(source_feed);var html_feed=template_feed(data_json);$("#feed").html(html_feed);var next_data=gen_next_list(label,data_json);next_data=eval("("+next_data+")");addNextSbiling(label,obj.id,label,next_data);var source_select=$("#select-linkage-template").html();var template_select=Handlebars.compile(source_select);var html_select=template_select(next_data);var ID="#"+label;$(ID).html(html_select)}})}function gen_next_list(parent,json_data){var arr1=[];var arr2=[];for(j=0;j<json_data.result.feed[0].tags.length;j++){if(json_data.result.feed[0].tags[j]!=parent){arr1.push(json_data.result.feed[0].tags[j])}}for(i=1;i<json_data.result.feed.length;i++){for(j=0;j<json_data.result.feed[i].tags.length;j++){if(json_data.result.feed[i].tags[j]!=parent){arr2.push(json_data.result.feed[i].tags[j])}}mergeArray(arr1,arr2)}var next_data='{"parent":"'+parent+'","children":[';for(i=0;i<arr1.length;i++){var temp='{"tag":"'+arr1[i]+'","ids":[';next_data+=temp;var num_id=0 for(j=0;j<json_data.result.feed.length;j++){var flag=0;for(k=0;k<json_data.result.feed[j].tags.length;k++){if(json_data.result.feed[j].tags[k]==arr1[i]){flag+=1}else if(json_data.result.feed[j].tags[k]==parent){flag+=1}}if(flag==2){num_id+=1}if(flag==2&&num_id>1){next_data+=','}if(flag==2){next_data+=json_data.result.feed[j].nr}if(j==json_data.result.feed.length-1){next_data+=']}'}}if(i!=arr1.length-1){next_data+=','}else{next_data+=']}'}}return next_data}function mergeArray(arr1,arr2){var dup;for(var i=0;i<arr2.length;i++){dup=false;for(var j=0;j<arr1.length;j++){if(arr1[j]==arr2[i]){dup=true;break}}if(!dup){arr1.push(arr2[i])}}return arr1}function addNextSbiling(select_1,nodeId,select_id,next_data){$("#"+nodeId).nextAll().remove();var currentNode=document.getElementById(nodeId);var mySelect=document.createElement("select");mySelect.setAttribute("id",select_id);mySelect.addEventListener('change',function(){return clickSelect.apply(this,[select_1,this.value,select_id,next_data])});currentNode.parentNode.appendChild(mySelect)}function clickSelect(select_1,value,parent,next_data){var obj=this.options[this.selectedIndex];upd_feed(value,select_1);var IdArray=value.split(",");var next_data_new=gen_next_taglist(IdArray,obj.text,next_data);addNextSbiling(select_1,this.id,obj.text,next_data_new);var source_select=$("#select-linkage-template").html();var template_select=Handlebars.compile(source_select);var html_select=template_select(next_data_new);var ID="#"+obj.text;$(ID).html(html_select)}function gen_next_taglist(IdArray,select_text,next_data){var arr1=[];var arr2=[];var flag=0 for(k=0;k<IdArray.length;k++){arr2=[];for(i=0;i<next_data.children.length;i++){for(j=0;j<next_data.children[i].ids.length;j++){if(parseInt(IdArray[k])==next_data.children[i].ids[j]&&select_text!=next_data.children[i].tag){arr2.push(next_data.children[i].tag);flag+=1;if(flag==1&&select_text!=next_data.children[i].tag){arr1.push(next_data.children[i].tag)}break}}}mergeArray(arr1,arr2)}var next_data_new={};next_data_new["parent"]=select_text;next_data_new["children"]=[];for(i=0;i<arr1.length;i++){next_data_new["children"][i]={};next_data_new["children"][i]["tag"]=arr1[i];for(j=0;j<next_data.children.length;j++){if(arr1[i]==next_data.children[j].tag){next_data_new["children"][i]["ids"]=[];num=0;for(k=0;k<next_data.children[j].ids.length;k++){for(p=0;p<IdArray.length;p++){if(next_data.children[j].ids[k]==parseInt(IdArray[p])){next_data_new["children"][i]["ids"][num]=next_data.children[j].ids[k];num+=1;break}}}}}}return next_data_new}function upd_feed(value,parent){var IdArray=value.split(",");url_github="https://cdn.jsdelivr.net/gh/xyongcn/piazza-data-tsinghua.edu.cn_spring2015_30240243x@master/data/piazza-data-filter/filter_feed_"+parent+".json";$.ajax({type:"get",cache:false,url:url_github,success:function(data){var data_json=find_feed(data,IdArray,parent);var source_feed=$("#feed-template").html();var template_feed=Handlebars.compile(source_feed);var html_feed=template_feed(data_json);$("#feed").html(html_feed)}})}function find_feed(data,IdArray,parent){var data_json=eval("("+data+")");var data_json_new={};data_json_new.result={};data_json_new.result.feed=[];for(i=0;i<IdArray.length;i++){var nr=parseInt(IdArray[i]);for(var j=0;j<data_json.result.feed.length;j++){var feed=data_json.result.feed[j];if(nr==feed.nr){data_json_new.result.feed[i]={};for(var key in feed){if(typeof(feed[key])=="object"){data_json_new.result.feed[i][key]=[];for(var key2 in feed[key]){if(feed[key][key2]!=parent){data_json_new.result.feed[i][key][key2]=feed[key][key2]}}}else{data_json_new.result.feed[i][key]=feed[key]}}}}}return data_json_new}
