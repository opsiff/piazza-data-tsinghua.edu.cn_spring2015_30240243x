{"aid": "igkpggtw46g4k", "error": null, "result": {"default_anonymity": "no", "status": "active", "i_edits": [], "q_edits": [], "bookmarked": 5, "request_instructor": 0, "history": [{"uid": "hdjonbiyfs62ie", "anon": "no", "created": "2015-04-08T06:09:47Z", "content": "<p>每个线程都有自己的堆栈&#xff0c;但有几个就有疑问了。请在线程创建代码中找到相应堆栈的创建代码。</p>\n<p></p>\n<p>请有兴趣的同学&#xff0c;回复自己的看法。也欢迎有疑问的同学提问。大家一起来讨论&#xff0c;把问题搞清楚。</p>", "subject": "每个线程有几个堆栈&#xff1f;"}], "s_edits": [], "tag_good_arr": [], "is_bookmarked": false, "my_favorite": false, "t": 1446635553332, "children": [{"uid": "i6s09f3xHOf", "no_answer": 0, "created": "2015-04-08T06:35:32Z", "id": "i88d3cf474t3rk", "updated": "2015-04-08T06:35:32Z", "subject": "<p>感觉每个线程有两个堆栈&#xff0c;一个用户态一个内核态&#xff0c;所有线程的内核态公用一个堆栈</p>\n<p>entry.S中初始化了内核态堆栈<br />relocated:<br /> # set ebp, esp<br /> movl $0x0, %ebp<br /> # the kernel stack region is from bootstack -- bootstacktop,<br /> # the kernel stack size is KSTACKSIZE (8KB)defined in memlayout.h<br /> movl $bootstacktop, %esp<br /> # now kernel stack is ready , call the first C function<br /> call kern_init</p>\n<p>proc.c中alloc_proc()中初始化context时初始化了用户态堆栈<br />struct context {<br /> uint32_t eip;<br /> uint32_t esp;<br /> uint32_t ebx;<br /> uint32_t ecx;<br /> uint32_t edx;<br /> uint32_t esi;<br /> uint32_t edi;<br /> uint32_t ebp;<br />};</p>", "anon": "no", "folders": [], "config": {}, "data": {"embed_links": null}, "bucket_order": 3, "bucket_name": "Yesterday", "no_upvotes": 0, "d-bucket": "Yesterday", "children": [{"uid": "hdjonbiyfs62ie", "created": "2015-04-09T01:12:21Z", "id": "i89gzkh1wze40e", "updated": "2015-04-09T01:12:21Z", "subject": "<p>好评。</p>", "anon": "no", "folders": [], "config": {}, "data": {"embed_links": null}, "bucket_order": 2, "bucket_name": "Today", "children": [], "type": "feedback"}], "type": "followup"}, {"uid": "i6uunp7jxDb", "no_answer": 0, "created": "2015-04-08T06:49:30Z", "id": "i88dlaff1ek48e", "updated": "2015-04-08T06:49:30Z", "subject": "<p>Kernel:</p>\n<pre>proc.c \ndo_fork():\n\nif (setup_kstack(proc) != 0) {\n    goto bad_fork_cleanup_proc;\n}\n\nsetup_kstack(struct proc_struct *proc) {\n    struct Page *page = alloc_pages(KSTACKPAGE);\n    if (page != NULL) {\n        proc-&gt;kstack = (uintptr_t)page2kva(page);\n        return 0;\n    }\n    return -E_NO_MEM;\n}</pre>\n<p>User: </p>\n<pre>proc.c\nalloc_proc():\nmemset(&amp;(proc-&gt;context), 0, sizeof(struct context));\n\nproc.h\nstruct context {\n    uint32_t eip;\n    uint32_t esp;\n    uint32_t ebx;\n    uint32_t ecx;\n    uint32_t edx;\n    uint32_t esi;\n    uint32_t edi;\n    uint32_t ebp;\n};<br /><br />copy_thread(struct proc_struct *proc, uintptr_t esp, struct trapframe *tf) {\n    proc-&gt;tf = (struct trapframe *)(proc-&gt;kstack &#43; KSTACKSIZE) - 1;\n    *(proc-&gt;tf) = *tf;\n    proc-&gt;tf-&gt;tf_regs.reg_eax = 0;\n    proc-&gt;tf-&gt;tf_esp = esp;\n    proc-&gt;tf-&gt;tf_eflags |= FL_IF;\n\n    proc-&gt;context.eip = (uintptr_t)forkret;\n    proc-&gt;context.esp = (uintptr_t)(proc-&gt;tf);\n}</pre>", "anon": "no", "folders": [], "config": {}, "data": {"embed_links": null}, "bucket_order": 3, "bucket_name": "Yesterday", "no_upvotes": 0, "d-bucket": "Yesterday", "children": [{"uid": "hdjonbiyfs62ie", "created": "2015-04-09T01:12:29Z", "id": "i89gzr2s2tf42w", "updated": "2015-04-09T01:12:29Z", "subject": "<p>好评。</p>", "anon": "no", "folders": [], "config": {}, "data": {"embed_links": null}, "bucket_order": 2, "bucket_name": "Today", "children": [], "type": "feedback"}], "type": "followup"}], "type": "note", "unique_views": 62, "created": "2015-04-08T06:09:47Z", "id": "i88c68612ac2tk", "tags": ["instructor-note", "课堂问答"], "nr": 256, "data": {"embed_links": []}, "upvote_ids": [], "is_tag_good": false, "config": {}, "folders": ["课堂问答"], "bucket_order": 2, "change_log": [{"uid": "hdjonbiyfs62ie", "when": "2015-04-08T06:09:47Z", "data": "i88c686t3fi2tl", "anon": "no", "type": "create"}, {"uid": "i6s09f3xHOf", "when": "2015-04-08T06:35:32Z", "to": "i88c68612ac2tk", "anon": "no", "type": "followup"}, {"uid": "i6uunp7jxDb", "when": "2015-04-08T06:49:30Z", "to": "i88c68612ac2tk", "anon": "no", "type": "followup"}, {"uid": "hdjonbiyfs62ie", "when": "2015-04-09T01:12:21Z", "to": "i88c68612ac2tk", "anon": "no", "type": "feedback"}, {"uid": "hdjonbiyfs62ie", "when": "2015-04-09T01:12:29Z", "to": "i88c68612ac2tk", "anon": "no", "type": "feedback"}], "bucket_name": "Today", "request_instructor_me": false, "no_answer_followup": 0, "num_favorites": 0, "tag_good": []}}